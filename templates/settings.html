{% extends "base.html" %}

{% block title %}Settings - CodingFlashcard{% endblock %}

{% block content %}
<div class="dashboard">
    <header class="dashboard-header">
        <a class="appbar-brand" href="{{ url_for('dashboard') }}" aria-label="CodingFlashcard Home">
            <span class="appbar-mark">CF</span>
            <span class="appbar-title">CodingFlashcard</span>
        </a>

        <nav class="appbar-nav" aria-label="Primary">
            <a href="{{ url_for('dashboard') }}" class="appbar-link">Practice</a>
            <a href="{{ url_for('all_problems') }}" class="appbar-link">All Problems</a>
        </nav>

        <div class="appbar-right">
            <div class="appbar-user" aria-label="Signed in user">
                <span class="appbar-user-name">{{ user.username }}</span>
                {% if user.profile_image %}
                    <img class="appbar-avatar" src="{{ url_for('static', filename=user.profile_image) }}" alt="Profile picture">
                {% else %}
                    <span class="appbar-user-dot" aria-hidden="true"></span>
                {% endif %}
            </div>
            <div class="settings-dropdown">
                <button type="button" class="btn-settings" id="settingsBtn" aria-haspopup="true" aria-expanded="false">
                    âš™
                </button>
                <div class="settings-menu" id="settingsMenu">
                    <a href="{{ url_for('settings') }}" class="settings-item active">Settings</a>
                    <a href="{{ url_for('change_password') }}" class="settings-item">Change Password</a>
                    <a href="{{ url_for('logout') }}" class="settings-item danger">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-content">
        <div class="settings-page-new">
            <!-- Settings Header -->
            <div class="settings-header">
                <h1 class="settings-title">Settings</h1>
                <p class="settings-subtitle">Manage your account preferences</p>
            </div>

            <!-- Profile Section -->
            <section class="settings-section">
                <div class="settings-section-header">
                    <span class="settings-section-icon">ðŸ‘¤</span>
                    <div>
                        <h2 class="settings-section-title">Profile</h2>
                        <p class="settings-section-desc">Your public information</p>
                    </div>
                </div>
                <div class="settings-section-body">
                    <div class="settings-row">
                        <div class="settings-row-info">
                            <div class="settings-row-label">Profile Picture</div>
                            <div class="settings-row-hint">Square image, auto-resized to 256Ã—256</div>
                        </div>
                        <div class="settings-row-action">
                            <div class="settings-avatar-group">
                                {% if user.profile_image %}
                                    <img class="settings-avatar-lg" src="{{ url_for('static', filename=user.profile_image) }}" alt="Profile">
                                {% else %}
                                    <div class="settings-avatar-placeholder">?</div>
                                {% endif %}
                                <div class="settings-avatar-buttons">
                                    <form method="POST" action="{{ url_for('upload_profile_picture') }}" enctype="multipart/form-data" class="settings-inline-form">
                                        <label class="btn-outline btn-sm">
                                            Upload
                                            <input type="file" name="profile_picture" accept="image/png,image/jpeg,image/webp" hidden onchange="this.form.submit()">
                                        </label>
                                    </form>
                                    {% if user.profile_image %}
                                        <form method="POST" action="{{ url_for('delete_profile_picture') }}" class="settings-inline-form">
                                            <button type="submit" class="btn-ghost btn-sm btn-danger">Remove</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-info">
                            <div class="settings-row-label">Username</div>
                            <div class="settings-row-hint">Your unique identifier</div>
                        </div>
                        <div class="settings-row-action">
                            <form method="POST" action="{{ url_for('update_username') }}" class="settings-inline-form">
                                <input type="text" name="username" value="{{ user.username }}" class="settings-input" required>
                                <button type="submit" class="btn-outline btn-sm">Update</button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Preferences Section -->
            <section class="settings-section">
                <div class="settings-section-header">
                    <span class="settings-section-icon">âš™</span>
                    <div>
                        <h2 class="settings-section-title">Preferences</h2>
                        <p class="settings-section-desc">Customize your experience</p>
                    </div>
                </div>
                <div class="settings-section-body">
                    <div class="settings-row">
                        <div class="settings-row-info">
                            <div class="settings-row-label">Timezone</div>
                            <div class="settings-row-hint">Used for scheduling and display</div>
                        </div>
                        <div class="settings-row-action">
                            <form method="POST" action="{{ url_for('update_timezone') }}" class="settings-inline-form">
                                <input
                                    type="text"
                                    name="timezone"
                                    list="timezoneList"
                                    value="{{ user.timezone or 'UTC' }}"
                                    placeholder="e.g. Asia/Dhaka"
                                    class="settings-input"
                                    required
                                >
                                <datalist id="timezoneList">
                                    {% for tz in timezones %}
                                        <option value="{{ tz }}"></option>
                                    {% endfor %}
                                </datalist>
                                <button type="submit" class="btn-outline btn-sm">Update</button>
                            </form>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-info">
                            <div class="settings-row-label">Daily Practice Email</div>
                            <div class="settings-row-hint">Get your practice list every day</div>
                        </div>
                        <div class="settings-row-action">
                            <form method="POST" action="{{ url_for('update_daily_email_settings') }}" class="settings-inline-form settings-email-form">
                                <label class="settings-toggle">
                                    <input type="checkbox" name="daily_email_enabled" {% if user.daily_email_enabled %}checked{% endif %}>
                                    <span class="settings-toggle-slider"></span>
                                </label>
                                <div class="settings-time-group">
                                    <span class="settings-time-label">at</span>
                                    <input type="time" name="daily_email_time" value="{{ user.daily_email_time or '06:00' }}" class="settings-input settings-input-time" required>
                                </div>
                                <button type="submit" class="btn-outline btn-sm">Save</button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Account Section -->
            <section class="settings-section">
                <div class="settings-section-header">
                    <span class="settings-section-icon">ðŸ”’</span>
                    <div>
                        <h2 class="settings-section-title">Account</h2>
                        <p class="settings-section-desc">Security and authentication</p>
                    </div>
                </div>
                <div class="settings-section-body">
                    <div class="settings-row">
                        <div class="settings-row-info">
                            <div class="settings-row-label">Email Address</div>
                            <div class="settings-row-hint">{{ user.email }}</div>
                        </div>
                        <div class="settings-row-action">
                            {% if not pending_email_change %}
                                <form method="POST" action="{{ url_for('request_email_change') }}" class="settings-inline-form">
                                    <input type="email" name="new_email" placeholder="new@email.com" class="settings-input" required>
                                    <button type="submit" class="btn-outline btn-sm">Change</button>
                                </form>
                            {% else %}
                                <div class="settings-pending-change">
                                    <div class="settings-pending-badge">Pending verification</div>
                                    <form method="POST" action="{{ url_for('confirm_email_change') }}" class="settings-verify-form">
                                        <div class="settings-verify-inputs">
                                            <input type="text" name="current_email_code" placeholder="Code (current)" class="settings-input settings-input-code" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" required>
                                            <input type="text" name="new_email_code" placeholder="Code (new)" class="settings-input settings-input-code" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" required>
                                        </div>
                                        <button type="submit" class="btn-outline btn-sm">Verify</button>
                                    </form>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-info">
                            <div class="settings-row-label">Password</div>
                            <div class="settings-row-hint">Last changed: unknown</div>
                        </div>
                        <div class="settings-row-action">
                            <a href="{{ url_for('change_password') }}" class="btn-outline btn-sm">Change Password</a>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>
</div>

<script>
// Settings dropdown
const settingsBtn = document.getElementById('settingsBtn');
const settingsMenu = document.getElementById('settingsMenu');

function closeSettingsMenu() {
  settingsMenu.classList.remove('open');
  settingsBtn.setAttribute('aria-expanded', 'false');
}

function toggleSettingsMenu() {
  const isOpen = settingsMenu.classList.contains('open');
  if (isOpen) closeSettingsMenu();
  else {
    settingsMenu.classList.add('open');
    settingsBtn.setAttribute('aria-expanded', 'true');
  }
}

settingsBtn?.addEventListener('click', (e) => {
  e.stopPropagation();
  toggleSettingsMenu();
});

document.addEventListener('click', () => closeSettingsMenu());
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeSettingsMenu();
});
</script>
{% endblock %}
