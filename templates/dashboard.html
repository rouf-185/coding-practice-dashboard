{% extends "base.html" %}

{% block title %}Dashboard - CodingFlashcard{% endblock %}

{% block content %}
<div class="dashboard">
    <header class="dashboard-header">
        <a class="appbar-brand" href="{{ url_for('dashboard') }}" aria-label="CodingFlashcard Home">
            <span class="appbar-mark">CF</span>
            <span class="appbar-title">CodingFlashcard</span>
        </a>

        <nav class="appbar-nav" aria-label="Primary">
            <a href="{{ url_for('dashboard') }}" class="appbar-link {% if request.endpoint == 'dashboard' %}active{% endif %}">Practice</a>
            <a href="{{ url_for('all_problems') }}" class="appbar-link {% if request.endpoint == 'all_problems' %}active{% endif %}">All Problems</a>
            <button type="button" onclick="openModal()" class="appbar-cta">Add Problem</button>
        </nav>

        <div class="appbar-right">
            <div class="appbar-user" aria-label="Signed in user">
                <span class="appbar-user-dot" aria-hidden="true"></span>
                <span class="appbar-user-name">{{ user.username }}</span>
            </div>
            <div class="settings-dropdown">
                <button type="button" class="btn-settings" aria-haspopup="true" aria-expanded="false" onclick="toggleHeaderSettings(event)">
                    ‚öô
                </button>
                <div class="settings-menu" id="headerSettingsMenu">
                    <a href="{{ url_for('settings') }}" class="settings-item">Settings</a>
                    <a href="{{ url_for('change_password') }}" class="settings-item">Change Password</a>
                    <a href="{{ url_for('logout') }}" class="settings-item danger">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-content">
        <!-- Top Section: Stats and Chart -->
        <div class="dashboard-top-section">
            <!-- Left: Practice Statistics (2x2x2 layout) -->
            <div class="stats-container-new">
                <div class="stats-row">
                    <div class="stats-card">
                        <div class="stat-icon">‚úì</div>
                        <div class="stat-content">
                            <div class="stat-number">{{ stats.fully_practiced }}</div>
                            <div class="stat-label">100% Practiced<br><span class="stat-sublabel">(‚â•3 times)</span></div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">‚óê</div>
                        <div class="stat-content">
                            <div class="stat-number">{{ stats.partially_practiced }}</div>
                            <div class="stat-label">Partially Practiced<br><span class="stat-sublabel">(2 times)</span></div>
                        </div>
                    </div>
                </div>
                <div class="stats-row">
                    <div class="stats-card">
                        <div class="stat-icon">‚óã</div>
                        <div class="stat-content">
                            <div class="stat-number">{{ stats.solved_once }}</div>
                            <div class="stat-label">Solved Once<br><span class="stat-sublabel">(1 time)</span></div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">‚Äî</div>
                        <div class="stat-content">
                            <div class="stat-number">{{ stats.not_practiced }}</div>
                            <div class="stat-label">Not Practiced<br><span class="stat-sublabel">(0 times)</span></div>
                        </div>
                    </div>
                </div>
                <div class="stats-row">
                    <div class="stats-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-content">
                            <div class="stat-number">{{ stats.practiced_today }}</div>
                            <div class="stat-label">Practiced Today<br><span class="stat-sublabel">(Today)</span></div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stat-icon">üìÜ</div>
                        <div class="stat-content">
                            <div class="stat-number">{{ stats.practiced_yesterday }}</div>
                            <div class="stat-label">Practiced Yesterday<br><span class="stat-sublabel">(Yesterday)</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Practice Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2>Problems Solved This Month</h2>
                    <div class="chart-controls">
                        <select id="yearSelect" class="chart-select">
                            {% set current_year = now.year %}
                            {% for year in range(current_year - 2, current_year + 1) %}
                                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                        <select id="monthSelect" class="chart-select">
                            {% set current_month = now.month %}
                            {% set months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}
                            {% for month_num in range(1, 13) %}
                                <option value="{{ month_num }}" {% if month_num == current_month %}selected{% endif %}>{{ months[month_num - 1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="chart-canvas-wrap">
                    <canvas id="practiceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Bottom Section: Problems to Practice Today -->
        <div class="practice-problems-section">
            <h2 class="section-title">Problems to Practice Today</h2>
            {% if grouped_problems %}
                {% set tabs = [
                    {'id': 'tab-2', 'label': '2 days before', 'key': 'Solved 2 days ago'},
                    {'id': 'tab-5', 'label': '5 days before', 'key': 'Solved 5 days ago'},
                    {'id': 'tab-10', 'label': '10 days before', 'key': 'Solved 10 days ago'},
                    {'id': 'tab-30', 'label': '30 days before', 'key': 'Solved 30 days ago'},
                    {'id': 'tab-random', 'label': 'Random pick', 'key': 'Random Practice'}
                ] %}

                <div class="practice-tabs" id="practiceTabs">
                    <div class="practice-tablist" role="tablist" aria-label="Practice buckets">
                        {% for t in tabs %}
                            {% set cnt = (grouped_problems.get(t.key, []) | length) %}
                            <button
                                type="button"
                                class="practice-tab-btn"
                                role="tab"
                                id="{{ t.id }}-btn"
                                aria-controls="{{ t.id }}-panel"
                                aria-selected="false"
                                data-tab="{{ t.id }}"
                                data-count="{{ cnt }}"
                            >
                                <span class="practice-tab-label">{{ t.label }}</span>
                                <span class="practice-tab-count">{{ cnt }}</span>
                            </button>
                        {% endfor %}
                    </div>

                    {% for t in tabs %}
                        {% set problems = grouped_problems.get(t.key, []) %}
                        <div
                            class="practice-tab-panel"
                            role="tabpanel"
                            id="{{ t.id }}-panel"
                            aria-labelledby="{{ t.id }}-btn"
                            data-tab-panel="{{ t.id }}"
                            hidden
                        >
                            {% if problems %}
                                <div class="practice-card-grid">
                                    {% for item in problems %}
                                        {% set problem = item.problem %}
                                        {% set solved_recently = item.solved_recently %}
                                        <div class="problem-card {% if problem.last_practiced %}solved{% endif %}">
                                            <div class="problem-header">
                                                <h3 class="problem-title">
                                                    {{ problem.title }}
                                                    {% if solved_recently %}
                                                        <span class="solved-badge">‚úì Solved</span>
                                                    {% endif %}
                                                </h3>
                                                <span class="difficulty-badge difficulty-{{ problem.difficulty }}">
                                                    {{ problem.difficulty.upper() }}
                                                </span>
                                            </div>
                                            <div class="problem-actions">
                                                <a href="{{ problem.leetcode_url }}" target="_blank" rel="noopener noreferrer" class="btn-leetcode">
                                                    View on Leetcode
                                                </a>
                                                <button type="button" class="btn-history js-history" data-problem-id="{{ problem.id }}">View History</button>
                                                <form method="POST" action="{{ url_for('mark_done', problem_id=problem.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn-done">Done</button>
                                                </form>
                                                <form method="POST" action="{{ url_for('delete_problem', problem_id=problem.id) }}" style="display: inline;" class="js-delete" data-problem-title="{{ problem.title }}">
                                                    <button type="submit" class="btn-delete">Delete</button>
                                                </form>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="practice-empty">
                                    <div class="practice-empty-title">No problems in this tab.</div>
                                    <div class="practice-empty-help">
                                        {% if t.key == 'Random Practice' %}
                                            Random pick shows on Saturday/Sunday.
                                        {% else %}
                                            Add more problems (or practice history) to populate this bucket.
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <h2>No problems to practice today!</h2>
                    <p>Add a problem to get started with your spaced repetition practice.</p>
                    <button onclick="openModal()" class="btn-primary">Add Your First Problem</button>
                </div>
            {% endif %}
        </div>
    </main>
</div>

<!-- Add Problem Modal -->
<div id="addProblemModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>Add Problem</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <form method="POST" action="{{ url_for('add_problem') }}">
            <div class="form-group">
                <label for="leetcode_url">Leetcode Problem URL</label>
                <input type="url" id="leetcode_url" name="leetcode_url" 
                       placeholder="https://leetcode.com/problems/four-divisors/description/" required>
            </div>
            <div class="form-group">
                <label for="difficulty">Difficulty</label>
                <select id="difficulty" name="difficulty" class="difficulty-select" required onchange="updateSelectColor(this)">
                    <option value="">Select difficulty...</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-primary">Add Problem</button>
            </div>
        </form>
    </div>
</div>

<!-- History Modal -->
<div id="historyModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="historyModalTitle">Problem History</h2>
            <button class="modal-close" onclick="closeHistoryModal()">√ó</button>
        </div>
        <div class="history-content">
            <div class="history-stats">
                <div class="stat-item">
                    <span class="stat-label">Added:</span>
                    <span class="stat-value" id="historyCreatedAt">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Practice Sessions:</span>
                    <span class="stat-value" id="historyTotalSessions">-</span>
                </div>
            </div>
            <div class="history-list-container">
                <h3>Practice History</h3>
                <div id="historyList" class="history-list">
                    <!-- History items will be inserted here -->
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeHistoryModal()" class="btn-secondary">Close</button>
        </div>
    </div>
</div>

<script>
function openModal() {
    document.getElementById('addProblemModal').style.display = 'flex';
    // Reset difficulty select color when opening modal
    const difficultySelect = document.getElementById('difficulty');
    if (difficultySelect) {
        difficultySelect.value = '';
        updateSelectColor(difficultySelect);
    }
}

function closeModal() {
    document.getElementById('addProblemModal').style.display = 'none';
}

function updateSelectColor(select) {
    const value = select.value;
    // Remove all color classes
    select.classList.remove('difficulty-easy', 'difficulty-medium', 'difficulty-hard');
    
    // Reset to default if no value selected
    if (!value) {
        select.style.backgroundColor = '#ffffff';
        select.style.color = '#000000';
        select.style.borderColor = '#000000';
        return;
    }
    
    // Apply color class based on selection
    if (value === 'easy') {
        select.classList.add('difficulty-easy');
    } else if (value === 'medium') {
        select.classList.add('difficulty-medium');
    } else if (value === 'hard') {
        select.classList.add('difficulty-hard');
    }
}

function viewHistory(problemId) {
    fetch(`/problem-history/${problemId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('historyModalTitle').textContent = data.title + ' - History';
            document.getElementById('historyCreatedAt').textContent = data.created_at;
            document.getElementById('historyTotalSessions').textContent = data.total_sessions;
            
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (data.history.length === 0) {
                historyList.innerHTML = '<p class="no-history">No practice history yet.</p>';
            } else {
                data.history.forEach((entry, index) => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <span class="history-number">${index + 1}</span>
                        <span class="history-date">${entry.date}</span>
                        <span class="history-time">${entry.time}</span>
                    `;
                    historyList.appendChild(item);
                });
            }
            
            document.getElementById('historyModal').style.display = 'flex';
        })
        .catch(error => {
            console.error('Error fetching history:', error);
            alert('Failed to load problem history.');
        });
}

function closeHistoryModal() {
    document.getElementById('historyModal').style.display = 'none';
}

function confirmDelete(problemTitle) {
    return confirm(`Are you sure you want to delete "${problemTitle}"? This action cannot be undone.`);
}

// Bind History / Delete events without inline JS (avoids template-linter issues)
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.js-history');
    if (!btn) return;
    const id = btn.getAttribute('data-problem-id');
    if (!id) return;
    viewHistory(id);
});

document.addEventListener('submit', function(e) {
    const form = e.target.closest('form.js-delete');
    if (!form) return;
    const title = form.getAttribute('data-problem-title') || 'this problem';
    if (!confirmDelete(title)) {
        e.preventDefault();
    }
});

// Close modal when clicking outside
document.getElementById('addProblemModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

document.getElementById('historyModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeHistoryModal();
    }
});

// Chart functionality
let practiceChart = null;

// Practice tabs
(function initPracticeTabs() {
    const root = document.getElementById('practiceTabs');
    if (!root) return;

    const buttons = Array.from(root.querySelectorAll('.practice-tab-btn'));
    const panels = Array.from(root.querySelectorAll('.practice-tab-panel'));
    if (!buttons.length || !panels.length) return;

    function setActive(tabId) {
        buttons.forEach(btn => {
            const active = btn.dataset.tab === tabId;
            btn.classList.toggle('active', active);
            btn.setAttribute('aria-selected', active ? 'true' : 'false');
        });
        panels.forEach(panel => {
            const active = panel.dataset.tabPanel === tabId;
            panel.hidden = !active;
        });
    }

    // Default: first tab with count > 0, else first tab.
    const firstNonEmpty = buttons.find(b => Number(b.dataset.count || '0') > 0);
    setActive((firstNonEmpty || buttons[0]).dataset.tab);

    buttons.forEach(btn => {
        btn.addEventListener('click', () => setActive(btn.dataset.tab));
    });
})();

// Header settings dropdown
function toggleHeaderSettings(e) {
    e.stopPropagation();
    const menu = document.getElementById('headerSettingsMenu');
    if (!menu) return;
    menu.classList.toggle('open');
}

document.addEventListener('click', function() {
    const menu = document.getElementById('headerSettingsMenu');
    if (menu) menu.classList.remove('open');
});

function loadChartData(year, month) {
    fetch(`/api/practice-data?year=${year}&month=${month}`)
        .then(response => response.json())
        .then(data => {
            updateChart(data);
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
        });
}

function updateChart(data) {
    const ctx = document.getElementById('practiceChart');
    if (!ctx) return;
    
    const chartCtx = ctx.getContext('2d');
    
    if (practiceChart) {
        practiceChart.destroy();
    }
    
    practiceChart = new Chart(chartCtx, {
        type: 'bar',
        data: {
            labels: data.days.map(day => day.toString()),
            datasets: [{
                label: 'Problems Solved',
                data: data.counts,
                backgroundColor: '#000000',
                borderColor: '#000000',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#000000'
                    },
                    grid: {
                        color: '#e0e0e0'
                    }
                },
                x: {
                    ticks: {
                        color: '#000000'
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Initialize chart on page load
const yearSelect = document.getElementById('yearSelect');
const monthSelect = document.getElementById('monthSelect');

if (yearSelect && monthSelect) {
    // Load initial chart data
    loadChartData(yearSelect.value, monthSelect.value);
    
    // Update chart when year or month changes
    yearSelect.addEventListener('change', function() {
        loadChartData(yearSelect.value, monthSelect.value);
    });
    
    monthSelect.addEventListener('change', function() {
        loadChartData(yearSelect.value, monthSelect.value);
    });
}
</script>
{% endblock %}

