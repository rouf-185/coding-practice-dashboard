{% extends "base.html" %}

{% block title %}Dashboard - CodingFlashcard{% endblock %}

{% block content %}
<div class="dashboard">
    <header class="dashboard-header">
        <a class="appbar-brand" href="{{ url_for('dashboard.index') }}" aria-label="CodingFlashcard Home">
            <span class="appbar-mark">CF</span>
            <span class="appbar-title">CodingFlashcard</span>
        </a>

        <nav class="appbar-nav" aria-label="Primary">
            <a href="{{ url_for('dashboard.index') }}" class="appbar-link {% if request.endpoint == 'dashboard.index' %}active{% endif %}">Practice</a>
            <a href="{{ url_for('problems.all_problems') }}" class="appbar-link {% if request.endpoint == 'problems.all_problems' %}active{% endif %}">All Problems</a>
        </nav>

        <div class="appbar-right">
            <button type="button" class="appbar-add" onclick="openModal()" aria-label="Add Problem" title="Add Problem">
                <span class="appbar-add-icon" aria-hidden="true">+</span>
            </button>
            <div class="appbar-user" aria-label="Signed in user">
                <span class="appbar-user-name">{{ user.username }}</span>
                {% if user.profile_image %}
                    <img class="appbar-avatar" src="{{ url_for('static', filename=user.profile_image) }}" alt="Profile picture">
                {% else %}
                    <span class="appbar-user-dot" aria-hidden="true"></span>
                {% endif %}
            </div>
            <div class="settings-dropdown">
                <button type="button" class="btn-settings" aria-haspopup="true" aria-expanded="false" onclick="toggleHeaderSettings(event)">
                    ☰
                </button>
                <div class="settings-menu" id="headerSettingsMenu">
                    <a href="{{ url_for('settings.index') }}" class="settings-item">Settings</a>
                    <a href="{{ url_for('auth.change_password') }}" class="settings-item">Change Password</a>
                    <a href="{{ url_for('auth.logout') }}" class="settings-item danger">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-content">
        <!-- Top Section: Stats and Chart -->
        <div class="dashboard-top-section">
            <!-- Left: Practice Statistics -->
            <div class="stats-container-new">
                <div class="stats-card">
                    <div class="stat-icon">✓</div>
                    <div class="stat-content">
                        <div class="stat-number">{{ stats.fully_practiced }}</div>
                        <div class="stat-label">Mastered</div>
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stat-icon">◐</div>
                    <div class="stat-content">
                        <div class="stat-number">{{ stats.partially_practiced }}</div>
                        <div class="stat-label">Learning</div>
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stat-icon">○</div>
                    <div class="stat-content">
                        <div class="stat-number">{{ stats.solved_once }}</div>
                        <div class="stat-label">Once</div>
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stat-icon">—</div>
                    <div class="stat-content">
                        <div class="stat-number">{{ stats.not_practiced }}</div>
                        <div class="stat-label">New</div>
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stat-icon">●</div>
                    <div class="stat-content">
                        <div class="stat-number">{{ stats.practiced_today }}</div>
                        <div class="stat-label">Today</div>
                    </div>
                </div>
                <div class="stats-card">
                    <div class="stat-icon">○</div>
                    <div class="stat-content">
                        <div class="stat-number">{{ stats.practiced_yesterday }}</div>
                        <div class="stat-label">Yesterday</div>
                    </div>
                </div>
            </div>

            <!-- Middle: Difficulty Pie Chart -->
            <div class="chart-container pie-chart-container">
                <div class="chart-header">
                    <h2>Difficulty</h2>
                    <div class="chart-controls pie-filters">
                        <button type="button" class="pie-filter-btn active" data-period="lifetime">All</button>
                        <button type="button" class="pie-filter-btn" data-period="year">Year</button>
                        <button type="button" class="pie-filter-btn" data-period="month">Month</button>
                        <button type="button" class="pie-filter-btn" data-period="week">Week</button>
                        <button type="button" class="pie-filter-btn" data-period="today">Today</button>
                    </div>
                </div>
                <div class="pie-chart-body">
                    <div class="leetcode-pie-wrapper">
                        <canvas id="difficultyChart"></canvas>
                        <div class="leetcode-pie-center">
                            <span class="pie-center-value" id="difficultyTotal">0</span>
                            <span class="pie-center-label">Solved</span>
                        </div>
                    </div>
                    <div class="pie-chart-legend">
                        <div class="legend-item legend-easy">
                            <span class="legend-dot"></span>
                            <span class="legend-label">Easy</span>
                            <span class="legend-value" id="legendEasy">0</span>
                        </div>
                        <div class="legend-item legend-medium">
                            <span class="legend-dot"></span>
                            <span class="legend-label">Medium</span>
                            <span class="legend-value" id="legendMedium">0</span>
                        </div>
                        <div class="legend-item legend-hard">
                            <span class="legend-dot"></span>
                            <span class="legend-label">Hard</span>
                            <span class="legend-value" id="legendHard">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Practice Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2>Daily Activity</h2>
                    <div class="chart-controls">
                        <select id="yearSelect" class="chart-select">
                            {% set current_year = now.year %}
                            {% for year in range(current_year - 2, current_year + 1) %}
                                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                        <select id="monthSelect" class="chart-select">
                            {% set current_month = now.month %}
                            {% set months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}
                            {% for month_num in range(1, 13) %}
                                <option value="{{ month_num }}" {% if month_num == current_month %}selected{% endif %}>{{ months[month_num - 1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="chart-canvas-wrap">
                    <canvas id="practiceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Goal + Heatmap Section -->
        <div class="goal-heatmap-section">
            <!-- Today's Goal -->
            <div class="goal-card">
                <div class="goal-header">
                    <h2>Today's Goal</h2>
                </div>
                <div class="goal-chart-container">
                    <div class="leetcode-pie-wrapper">
                        <canvas id="goalChart"></canvas>
                        <div class="leetcode-pie-center">
                            <span class="pie-center-value">{{ goal_progress.done }}/{{ goal_progress.total }}</span>
                            <span class="pie-center-label">Done</span>
                        </div>
                    </div>
                </div>
                <div class="goal-stats">
                    <div class="goal-stat">
                        <span class="goal-stat-dot done"></span>
                        <span class="goal-stat-label">Completed</span>
                        <span class="goal-stat-value">{{ goal_progress.done }}</span>
                    </div>
                    <div class="goal-stat">
                        <span class="goal-stat-dot remaining"></span>
                        <span class="goal-stat-label">Remaining</span>
                        <span class="goal-stat-value">{{ goal_progress.remaining }}</span>
                    </div>
                </div>
            </div>

            <!-- Heatmap -->
            <div class="heatmap-section">
                <div class="heatmap-header">
                    <h2>Activity</h2>
                    <div class="heatmap-controls">
                        <select id="heatmapYearSelect" class="chart-select">
                            {% set current_year = now.year %}
                            {% for year in range(current_year - 2, current_year + 1) %}
                                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                        <span class="heatmap-summary" id="heatmapSummary"></span>
                    </div>
                </div>
                <div class="heatmap-container">
                    <div class="heatmap-months-grid" id="heatmapMonthsGrid"></div>
                </div>
                <div class="heatmap-legend">
                    <span class="heatmap-legend-label">Less</span>
                    <div class="heatmap-legend-scale">
                        <span class="heatmap-cell level-0"></span>
                        <span class="heatmap-cell level-1"></span>
                        <span class="heatmap-cell level-2"></span>
                        <span class="heatmap-cell level-3"></span>
                        <span class="heatmap-cell level-4"></span>
                    </div>
                    <span class="heatmap-legend-label">More</span>
                </div>
            </div>
        </div>

        <!-- Bottom Section: Problems to Practice Today -->
        <div class="practice-problems-section">
            <h2 class="section-title">Problems to Practice Today</h2>
            {% if grouped_problems %}
                {% set tabs = [
                    {'id': 'tab-2', 'label': '2 days before', 'key': 'Solved 2 days ago'},
                    {'id': 'tab-5', 'label': '5 days before', 'key': 'Solved 5 days ago'},
                    {'id': 'tab-10', 'label': '10 days before', 'key': 'Solved 10 days ago'},
                    {'id': 'tab-30', 'label': '30 days before', 'key': 'Solved 30 days ago'},
                    {'id': 'tab-random', 'label': 'Random pick', 'key': 'Random Practice'}
                ] %}

                <div class="practice-tabs" id="practiceTabs">
                    <div class="practice-tablist" role="tablist" aria-label="Practice buckets">
                        {% for t in tabs %}
                            {% set cnt = (grouped_problems.get(t.key, []) | length) %}
                            <button
                                type="button"
                                class="practice-tab-btn"
                                role="tab"
                                id="{{ t.id }}-btn"
                                aria-controls="{{ t.id }}-panel"
                                aria-selected="false"
                                data-tab="{{ t.id }}"
                                data-count="{{ cnt }}"
                            >
                                <span class="practice-tab-label">{{ t.label }}</span>
                                <span class="practice-tab-count">{{ cnt }}</span>
                            </button>
                        {% endfor %}
                    </div>

                    {% for t in tabs %}
                        {% set problems = grouped_problems.get(t.key, []) %}
                        <div
                            class="practice-tab-panel"
                            role="tabpanel"
                            id="{{ t.id }}-panel"
                            aria-labelledby="{{ t.id }}-btn"
                            data-tab-panel="{{ t.id }}"
                            hidden
                        >
                            {% if problems %}
                                <div class="practice-card-grid">
                                    {% for item in problems %}
                                        {% set problem = item.problem %}
                                        {% set solved_recently = item.solved_recently %}
                                        <div class="problem-card {% if problem.last_practiced %}solved{% endif %}">
                                            <div class="problem-header">
                                                <h3 class="problem-title">
                                                    {{ problem.title }}
                                                    {% if solved_recently %}
                                                        <span class="solved-badge">✓ Solved</span>
                                                    {% endif %}
                                                </h3>
                                                <span class="difficulty-badge difficulty-{{ problem.difficulty }}">
                                                    {{ problem.difficulty.upper() }}
                                                </span>
                                            </div>
                                            <div class="problem-actions">
                                                <a href="{{ problem.leetcode_url }}" target="_blank" rel="noopener noreferrer" class="btn-leetcode">
                                                    View on Leetcode
                                                </a>
                                                <button type="button" class="btn-history js-history" data-problem-id="{{ problem.id }}">View History</button>
                                                <form method="POST" action="{{ url_for('problems.mark_done', problem_id=problem.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn-done">Done</button>
                                                </form>
                                                <form method="POST" action="{{ url_for('problems.delete_problem', problem_id=problem.id) }}" style="display: inline;" class="js-delete" data-problem-title="{{ problem.title }}">
                                                    <button type="submit" class="btn-delete">Delete</button>
                                                </form>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="practice-empty">
                                    <div class="practice-empty-title">No problems in this tab.</div>
                                    <div class="practice-empty-help">
                                        {% if t.key == 'Random Practice' %}
                                            Random pick shows on Saturday/Sunday.
                                        {% else %}
                                            Add more problems (or practice history) to populate this bucket.
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <h2>No problems to practice today!</h2>
                    <p>Add a problem to get started with your spaced repetition practice.</p>
                    <button onclick="openModal()" class="btn-primary">Add Your First Problem</button>
                </div>
            {% endif %}
        </div>
    </main>
</div>

<!-- Add Problem Modal -->
<div id="addProblemModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>Add Problem</h2>
            <button class="modal-close" onclick="closeModal()">×</button>
        </div>
        <form method="POST" action="{{ url_for('problems.add_problem') }}">
            <div class="form-group">
                <label for="leetcode_url">Leetcode Problem URL</label>
                <input type="url" id="leetcode_url" name="leetcode_url" 
                       placeholder="https://leetcode.com/problems/four-divisors/description/" required>
            </div>
            <div class="form-group">
                <label for="difficulty">Difficulty</label>
                <select id="difficulty" name="difficulty" class="difficulty-select" required onchange="updateSelectColor(this)">
                    <option value="">Select difficulty...</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-primary">Add Problem</button>
            </div>
        </form>
    </div>
</div>

<!-- History Modal -->
<div id="historyModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="historyModalTitle">Problem History</h2>
            <button class="modal-close" onclick="closeHistoryModal()">×</button>
        </div>
        <div class="history-content">
            <div class="history-stats">
                <div class="stat-item">
                    <span class="stat-label">Added:</span>
                    <span class="stat-value" id="historyCreatedAt">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Practice Sessions:</span>
                    <span class="stat-value" id="historyTotalSessions">-</span>
                </div>
            </div>
            <div class="history-list-container">
                <h3>Practice History</h3>
                <div id="historyList" class="history-list">
                    <!-- History items will be inserted here -->
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" onclick="closeHistoryModal()" class="btn-secondary">Close</button>
        </div>
    </div>
</div>

<script>
function openModal() {
    document.getElementById('addProblemModal').style.display = 'flex';
    // Reset difficulty select color when opening modal
    const difficultySelect = document.getElementById('difficulty');
    if (difficultySelect) {
        difficultySelect.value = '';
        updateSelectColor(difficultySelect);
    }
}

function closeModal() {
    document.getElementById('addProblemModal').style.display = 'none';
}

function updateSelectColor(select) {
    const value = select.value;
    // Remove all color classes
    select.classList.remove('difficulty-easy', 'difficulty-medium', 'difficulty-hard');
    
    // Reset to default if no value selected
    if (!value) {
        select.style.backgroundColor = '#ffffff';
        select.style.color = '#000000';
        select.style.borderColor = '#000000';
        return;
    }
    
    // Apply color class based on selection
    if (value === 'easy') {
        select.classList.add('difficulty-easy');
    } else if (value === 'medium') {
        select.classList.add('difficulty-medium');
    } else if (value === 'hard') {
        select.classList.add('difficulty-hard');
    }
}

function viewHistory(problemId) {
    fetch(`/api/problem-history/${problemId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('historyModalTitle').textContent = data.title + ' - History';
            document.getElementById('historyCreatedAt').textContent = data.created_at;
            document.getElementById('historyTotalSessions').textContent = data.total_sessions;
            
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (data.history.length === 0) {
                historyList.innerHTML = '<p class="no-history">No practice history yet.</p>';
            } else {
                data.history.forEach((entry, index) => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <span class="history-number">${index + 1}</span>
                        <span class="history-date">${entry.date}</span>
                        <span class="history-time">${entry.time}</span>
                    `;
                    historyList.appendChild(item);
                });
            }
            
            document.getElementById('historyModal').style.display = 'flex';
        })
        .catch(error => {
            console.error('Error fetching history:', error);
            alert('Failed to load problem history.');
        });
}

function closeHistoryModal() {
    document.getElementById('historyModal').style.display = 'none';
}

function confirmDelete(problemTitle) {
    return confirm(`Are you sure you want to delete "${problemTitle}"? This action cannot be undone.`);
}

// Bind History / Delete events without inline JS (avoids template-linter issues)
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.js-history');
    if (!btn) return;
    const id = btn.getAttribute('data-problem-id');
    if (!id) return;
    viewHistory(id);
});

document.addEventListener('submit', function(e) {
    const form = e.target.closest('form.js-delete');
    if (!form) return;
    const title = form.getAttribute('data-problem-title') || 'this problem';
    if (!confirmDelete(title)) {
        e.preventDefault();
    }
});

// Close modal when clicking outside
document.getElementById('addProblemModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

document.getElementById('historyModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeHistoryModal();
    }
});
</script>
{% endblock %}

{% block scripts %}
<script>
// Chart functionality
let practiceChart = null;
let difficultyChart = null;
let goalChart = null;

// Initialize Goal Chart
(function initGoalChart() {
    const ctx = document.getElementById('goalChart');
    if (!ctx) return;
    
    const done = {{ goal_progress.done | default(0) }};
    const remaining = {{ goal_progress.remaining | default(0) }};
    const total = done + remaining;
    
    const chartCtx = ctx.getContext('2d');
    
    if (total === 0) {
        goalChart = new Chart(chartCtx, {
            type: 'doughnut',
            data: {
                labels: ['No Tasks'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#f0f0f0'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '75%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
        return;
    }
    
    goalChart = new Chart(chartCtx, {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Remaining'],
            datasets: [{
                data: [done, remaining],
                backgroundColor: ['#22c55e', '#e5e5e5'],
                borderWidth: 0,
                hoverOffset: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '75%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#262626',
                    padding: 8,
                    cornerRadius: 4,
                    bodyFont: { size: 12 }
                }
            }
        }
    });
})();

// Difficulty Pie Chart
function loadDifficultyData(period) {
    fetch(`/api/difficulty-stats?period=${period}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Difficulty data:', data);
            updateDifficultyChart(data);
            updateDifficultyLegend(data);
        })
        .catch(error => {
            console.error('Error loading difficulty data:', error);
        });
}

function updateDifficultyChart(data) {
    const ctx = document.getElementById('difficultyChart');
    if (!ctx) return;
    
    const chartCtx = ctx.getContext('2d');
    
    if (difficultyChart) {
        difficultyChart.destroy();
    }
    
    const total = data.easy + data.medium + data.hard;
    
    // If no data, show empty state
    if (total === 0) {
        difficultyChart = new Chart(chartCtx, {
            type: 'doughnut',
            data: {
                labels: ['No Data'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#f0f0f0'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
        return;
    }
    
    difficultyChart = new Chart(chartCtx, {
        type: 'doughnut',
        data: {
            labels: ['Easy', 'Medium', 'Hard'],
            datasets: [{
                data: [data.easy, data.medium, data.hard],
                backgroundColor: ['#22c55e', '#f97316', '#ef4444'],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '70%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#262626',
                    padding: 10,
                    cornerRadius: 4,
                    titleFont: { size: 13, weight: '500' },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return ` ${value} (${pct}%)`;
                        }
                    }
                }
            }
        }
    });
}

function updateDifficultyLegend(data) {
    document.getElementById('legendEasy').textContent = data.easy;
    document.getElementById('legendMedium').textContent = data.medium;
    document.getElementById('legendHard').textContent = data.hard;
    const total = data.easy + data.medium + data.hard;
    const totalEl = document.getElementById('difficultyTotal');
    if (totalEl) totalEl.textContent = total;
}

// Initialize pie chart filters
(function initPieFilters() {
    const filterBtns = document.querySelectorAll('.pie-filter-btn');
    if (!filterBtns.length) return;
    
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            loadDifficultyData(this.dataset.period);
        });
    });
    
    // Load initial data
    loadDifficultyData('lifetime');
})();

// Practice tabs
(function initPracticeTabs() {
    const root = document.getElementById('practiceTabs');
    if (!root) return;

    const buttons = Array.from(root.querySelectorAll('.practice-tab-btn'));
    const panels = Array.from(root.querySelectorAll('.practice-tab-panel'));
    if (!buttons.length || !panels.length) return;

    function setActive(tabId) {
        buttons.forEach(btn => {
            const active = btn.dataset.tab === tabId;
            btn.classList.toggle('active', active);
            btn.setAttribute('aria-selected', active ? 'true' : 'false');
        });
        panels.forEach(panel => {
            const active = panel.dataset.tabPanel === tabId;
            panel.hidden = !active;
        });
    }

    // Default: first tab with count > 0, else first tab.
    const firstNonEmpty = buttons.find(b => Number(b.dataset.count || '0') > 0);
    setActive((firstNonEmpty || buttons[0]).dataset.tab);

    buttons.forEach(btn => {
        btn.addEventListener('click', () => setActive(btn.dataset.tab));
    });
})();

// Header settings dropdown
function toggleHeaderSettings(e) {
    e.stopPropagation();
    const menu = document.getElementById('headerSettingsMenu');
    if (!menu) return;
    menu.classList.toggle('open');
}

document.addEventListener('click', function() {
    const menu = document.getElementById('headerSettingsMenu');
    if (menu) menu.classList.remove('open');
});

function loadChartData(year, month) {
    fetch(`/api/practice-data?year=${year}&month=${month}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Practice data:', data);
            updateChart(data);
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
        });
}

function updateChart(data) {
    const ctx = document.getElementById('practiceChart');
    if (!ctx) return;
    
    const chartCtx = ctx.getContext('2d');
    
    if (practiceChart) {
        practiceChart.destroy();
    }
    
    practiceChart = new Chart(chartCtx, {
        type: 'bar',
        data: {
            labels: data.days.map(day => day.toString()),
            datasets: [{
                label: 'Problems Solved',
                data: data.counts,
                backgroundColor: '#595959',
                borderColor: '#595959',
                borderWidth: 0,
                borderRadius: 3,
                barPercentage: 0.6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: '#262626',
                    padding: 10,
                    cornerRadius: 4
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#8c8c8c',
                        font: { size: 11 }
                    },
                    grid: {
                        color: '#f0f0f0'
                    }
                },
                x: {
                    ticks: {
                        color: '#8c8c8c',
                        font: { size: 11 }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Initialize chart on page load
const yearSelect = document.getElementById('yearSelect');
const monthSelect = document.getElementById('monthSelect');

if (yearSelect && monthSelect) {
    // Load initial chart data
    loadChartData(yearSelect.value, monthSelect.value);
    
    // Update chart when year or month changes
    yearSelect.addEventListener('change', function() {
        loadChartData(yearSelect.value, monthSelect.value);
    });
    
    monthSelect.addEventListener('change', function() {
        loadChartData(yearSelect.value, monthSelect.value);
    });
}

// Heatmap
const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

function loadHeatmapData(year) {
    fetch(`/api/heatmap-data?year=${year}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Heatmap data:', data);
            renderHeatmap(data);
        })
        .catch(error => {
            console.error('Error loading heatmap data:', error);
        });
}

// Helper to format date as YYYY-MM-DD without timezone issues
function formatDateLocal(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}

function renderHeatmap(data) {
    const container = document.getElementById('heatmapMonthsGrid');
    const summaryEl = document.getElementById('heatmapSummary');
    if (!container) return;
    
    // Clear existing content
    container.innerHTML = '';
    
    const year = data.year;
    const activityData = data.data || {};
    const maxCount = data.max_count || 1;
    
    // Update summary
    if (summaryEl) {
        summaryEl.textContent = `${data.total_activities} activities in ${data.active_days} days`;
    }
    
    // Generate each month as a separate block
    for (let month = 0; month < 12; month++) {
        const monthBlock = document.createElement('div');
        monthBlock.className = 'heatmap-month-block';
        
        // Month label
        const monthLabel = document.createElement('div');
        monthLabel.className = 'heatmap-month-label';
        monthLabel.textContent = MONTHS[month];
        monthBlock.appendChild(monthLabel);
        
        // Month grid
        const monthGrid = document.createElement('div');
        monthGrid.className = 'heatmap-month-grid';
        
        // Get first and last day of month
        const firstOfMonth = new Date(year, month, 1);
        const lastOfMonth = new Date(year, month + 1, 0);
        
        // Start from the Sunday of the week containing the 1st
        const startDate = new Date(firstOfMonth);
        startDate.setDate(startDate.getDate() - startDate.getDay());
        
        // Generate weeks for this month
        let currentDate = new Date(startDate);
        
        while (currentDate <= lastOfMonth) {
            const weekDiv = document.createElement('div');
            weekDiv.className = 'heatmap-week';
            
            for (let day = 0; day < 7; day++) {
                const cell = document.createElement('span');
                cell.className = 'heatmap-cell';
                
                // Check if date is within this month
                if (currentDate.getMonth() === month && currentDate.getFullYear() === year) {
                    const dateStr = formatDateLocal(currentDate);
                    const count = activityData[dateStr] || 0;
                    const level = getActivityLevel(count, maxCount);
                    
                    cell.classList.add(`level-${level}`);
                    
                    // Tooltip
                    const dayNum = currentDate.getDate();
                    const tooltip = count > 0 
                        ? `${count} ${count === 1 ? 'activity' : 'activities'} on ${MONTHS[month]} ${dayNum}`
                        : `No activity on ${MONTHS[month]} ${dayNum}`;
                    cell.setAttribute('data-tooltip', tooltip);
                } else {
                    cell.classList.add('empty');
                }
                
                weekDiv.appendChild(cell);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            monthGrid.appendChild(weekDiv);
        }
        
        monthBlock.appendChild(monthGrid);
        container.appendChild(monthBlock);
    }
}

function getActivityLevel(count, maxCount) {
    if (count === 0) return 0;
    if (maxCount <= 1) return count > 0 ? 2 : 0;
    
    const ratio = count / maxCount;
    if (ratio <= 0.25) return 1;
    if (ratio <= 0.5) return 2;
    if (ratio <= 0.75) return 3;
    return 4;
}

// Initialize heatmap
const heatmapYearSelect = document.getElementById('heatmapYearSelect');
if (heatmapYearSelect) {
    loadHeatmapData(heatmapYearSelect.value);
    
    heatmapYearSelect.addEventListener('change', function() {
        loadHeatmapData(this.value);
    });
}
</script>
{% endblock scripts %}

